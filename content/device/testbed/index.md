---
title: ğŸ’¦ äº’è”äº’é€šæµ‹è¯•TestBedæ­å»ºæµç¨‹
summary: Docs to enable CaaS Switches' time synchronization logic and set up TSN GCL (gate control list), switch forwarding rules (including to dual-DMA).
date: 2024-05-01
authors:
  - admin
tags:
  - ZIGGO-SWITCH
  - ZIGGO
  - Markdown
image:
  caption: "TBD"
weight: 10
---
## ç›®å½•

- [ç›®å½•](#ç›®å½•)
- [TestBedç®€å•ä»‹ç»](#testbedç®€å•ä»‹ç»)
- [äº’è”äº’é€šæµ‹è¯•é¡¹ç›®ä»‹ç»](#äº’è”äº’é€šæµ‹è¯•é¡¹ç›®ä»‹ç»)
  - [1. åŸºå‡†æµ‹è¯•](#1-åŸºå‡†æµ‹è¯•)
  - [2. é—¨æ§èƒ½åŠ›](#2-é—¨æ§èƒ½åŠ›)
  - [3. å¸¦å®½ä¿è¯](#3-å¸¦å®½ä¿è¯)
  - [4. é—¨æ§ç²¾åº¦](#4-é—¨æ§ç²¾åº¦)
- [è®¾å¤‡å‚æ•°è®¾ç½®ä¸éƒ¨ç½²](#è®¾å¤‡å‚æ•°è®¾ç½®ä¸éƒ¨ç½²)
- [TestBedè¿è¡Œæµç¨‹](#testbedè¿è¡Œæµç¨‹)
  - [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
    - [æ§åˆ¶è„šæœ¬å‡†å¤‡](#æ§åˆ¶è„šæœ¬å‡†å¤‡)
    - [èƒŒæ™¯æµé‡å‘é€](#èƒŒæ™¯æµé‡å‘é€)
  - [åŸºå‡†æµ‹è¯•](#åŸºå‡†æµ‹è¯•)
  - [é—¨æ§èƒ½åŠ›](#é—¨æ§èƒ½åŠ›)
  - [å¸¦å®½ä¿è¯](#å¸¦å®½ä¿è¯)
  - [é—¨æ§ç²¾åº¦](#é—¨æ§ç²¾åº¦)

## TestBedç®€å•ä»‹ç»

æˆ‘ä»¬å†…éƒ¨å¯¹è‡ªå·±ç ”å‘çš„CaaS-Switchè¿›è¡Œäº†äº’è”äº’é€šæµ‹è¯•ï¼Œé‡‡ç”¨çš„ç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹æ‰€ç¤ºã€‚

![topo](./topo.PNG)

æœ¬Demoéœ€è¦4ä¸ªFPGAå¼€å‘æ¿ï¼ˆ2ä¸ªTSNPerfã€2ä¸ªCaaS-Switchï¼‰å’Œ1å°æ™®é€šPCã€‚å¦‚æœæ¡ä»¶æœ‰é™/è€ƒè™‘ç®€åŒ–æ‹“æ‰‘ï¼Œå¯ä»¥åˆ å»ä¸€ä¸ªCaaS-Switchã€‚PCè´Ÿè´£å‘é€èƒŒæ™¯æµé‡ï¼Œè·¯å¾„ä¸ºé»‘è‰²ç®­å¤´ï¼›å·¦ä¾§TSNPerfè´Ÿè´£å‘é€æµ‹è¯•æµé‡ï¼ˆå…³é”®æµé‡ï¼‰ï¼Œè·¯å¾„ä¸ºçº¢è‰²ç®­å¤´ã€‚

æ‰€æœ‰æµ‹è¯•é¡¹ç›®çš„æµç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

1. æ—¶é—´åŒæ­¥ï¼šå¯åŠ¨æ—¶é—´åŒæ­¥ï¼Œä¿è¯TSNPerfã€CaaS-Switchåœ¨ä¸€ä¸ªæ—¶é’ŸåŸŸä¸‹ã€‚

   æ³¨ï¼šæ—¶é—´åŒæ­¥ç¨‹åºè¿è¡Œåœ¨TSNPerfã€CaaS-Switchçš„ç³»ç»Ÿä¸­ã€‚

2. å‘é€æµ‹è¯•æµé‡ï¼šæ ¹æ®schedule.jsonæ–‡ä»¶ï¼ŒTSNPerfè¿›è¡Œæµ‹è¯•æµé‡å‘é€ã€‚

## äº’è”äº’é€šæµ‹è¯•é¡¹ç›®ä»‹ç»

### 1. åŸºå‡†æµ‹è¯•

- ç›®çš„ï¼šæµ‹è¯•æ— èƒŒæ™¯æµé‡æƒ…å†µä¸‹ï¼Œé«˜ä¼˜å…ˆçº§æµé‡çš„ä¸¤è·³ç«¯åˆ°ç«¯å»¶è¿Ÿã€ä¸¢åŒ…ç‡ã€æŠ–åŠ¨ï¼Œä½œä¸ºæ¯”è¾ƒåŸºå‡†ã€‚
- é¢„æœŸï¼šå»¶è¿Ÿç¬¦åˆè§„åˆ’ï¼ŒæŠ–åŠ¨è¾ƒä½ï¼ˆ100nså·¦å³ï¼‰ã€‚

### 2. é—¨æ§èƒ½åŠ›

- ç›®çš„ï¼šæµ‹è¯•é€šç”¨æƒ…å†µä¸‹æµé‡è°ƒåº¦æ•ˆæœï¼Œå’Œä¸¤ä¸ªäº¤æ¢æœºçš„é—¨æ§å¯¹æ¥èƒ½åŠ›ã€‚
- æ–¹æ¡ˆï¼š
  èƒŒæ™¯æµé‡ï¼ˆVLAN priority = 0ï¼‰æ‰“åˆ°çº¿é€Ÿï¼Œæ¯ä¸ªè°ƒåº¦å‘¨æœŸé¢„ç•™é•¿åº¦ä¸º 3 çš„æ—¶éš™ç»™é«˜ä¼˜å…ˆçº§æµé‡ï¼Œ
  1. æ¯ä¸ªå‘¨æœŸå®šæ—¶å‘é€ 4 ä¸ªæ•°æ®åŒ…é•¿åº¦ä¸º 1500Byte çš„é«˜ä¼˜å…ˆçº§ï¼ˆVLAN priority = 1ï¼‰æµ‹è¯•æµé‡ï¼Œè®°å½•ç«¯åˆ°ç«¯å¹³å‡å»¶è¿Ÿã€æŠ–åŠ¨ã€ä¸¢åŒ…ç‡ã€åˆ°è¾¾é¡ºåº
  2. æ¯ä¸ªå‘¨æœŸå®šæ—¶å‘é€ 8 ä¸ªæ•°æ®åŒ…é•¿åº¦ä¸º 1500Byte çš„é«˜ä¼˜å…ˆçº§ï¼ˆVLAN priority = 1ï¼‰æµ‹è¯•æµé‡ï¼Œè®°å½•æ˜¯å¦æ¯ä¸ªå‘¨æœŸé€šè¿‡ä¸”ä»… n ä¸ªåŒ…
- é¢„æœŸï¼š
  1. å»¶è¿Ÿã€æŠ–åŠ¨ã€ä¸¢åŒ…ç‡å’ŒåŸºå‡†ä¸€è‡´
  2. æ¯ä¸ªå‘¨æœŸå®šæ—¶å‘é€ 4 ä¸ªæ•°æ®åŒ…æ—¶ï¼Œä¸¢åŒ…ç‡ä¸º0
  3. æ¯ä¸ªå‘¨æœŸå®šæ—¶å‘é€ 8 ä¸ªæ•°æ®åŒ…æ—¶ï¼Œæ¯ä¸ªå‘¨æœŸé€šè¿‡ä¸”ä»…é€šè¿‡ 5 ä¸ªåŒ…ï¼ˆæ¯8ä¸ªåŒ…ä¸¢3ä¸ªï¼Œå› ä¸ºæ¯ä¸ªæ—¶éš™é‡Œæ°å¥½å¯ä»¥æŠŠç¬¬äº”ä¸ªåŒ…å‘å‡ºå»ï¼Œä½™ä¸‹ä¸‰ä¸ªåŒ…ä¸¢æ‰ï¼‰ï¼Œä¸¢åŒ…ç‡ä¸º37.5%

### 3. å¸¦å®½ä¿è¯

- ç›®çš„ï¼šæµ‹è¯•äº¤æ¢æœºèƒ½å¤Ÿè¿›è¡Œå¸¦å®½é¢„ç•™ï¼Œä¸”ä¸¤ä¸ªäº¤æ¢æœºä¼˜å…ˆçº§æ˜ å°„ã€è¿è¡Œ cycle å’Œ offset åŸºæœ¬ä¸€è‡´ã€‚
- æ–¹æ¡ˆï¼š
  èƒŒæ™¯æµé‡ï¼ˆVLAN priority = 0ï¼‰æ‰“åˆ°çº¿é€Ÿï¼ˆ1Gbpsï¼‰ï¼Œé…ç½®äº¤æ¢æœºé¢„ç•™ 50% æ—¶éš™ç»™é«˜ä¼˜å…ˆçº§æµé‡ï¼ˆVLAN priority = 1ï¼‰ï¼Œå…¶ä½™ 50% åªå…è®¸ä½ä¼˜å…ˆçº§æµé‡ï¼Œ
  1. æµ‹è¯•æµé‡é«˜ä¼˜å…ˆçº§ï¼ˆVLAN priority = 1ï¼‰æƒ…å†µä¸‹æ‰“åˆ°çº¿é€Ÿï¼ˆç»æµ‹è¯•ï¼Œæ¯ä¸ªå‘¨æœŸ[33ms]è¿ç»­å‘é€2752ä¸ª1500Bçš„åŒ…ï¼ŒåŸºæœ¬è¾¾åˆ°1000Mbpsï¼‰ï¼Œè®°å½•ç«¯åˆ°ç«¯å¹³å‡å»¶è¿Ÿã€æŠ–åŠ¨ã€ä¸¢åŒ…ç‡ã€åˆ°è¾¾é¡ºåº
  2. æµ‹è¯•æµé‡é«˜ä¼˜å…ˆçº§ï¼ˆVLAN priority = 1ï¼‰æƒ…å†µä¸‹æ‰“åˆ°50%çº¿é€Ÿï¼ˆæ¯ä¸ªå‘¨æœŸ[33ms]è¿ç»­å‘é€1376ä¸ª1500Bçš„åŒ…ï¼‰ï¼Œè®°å½•ç«¯åˆ°ç«¯å¹³å‡å»¶è¿Ÿã€æŠ–åŠ¨ã€ä¸¢åŒ…ç‡ã€åˆ°è¾¾é¡ºåº
- é¢„æœŸï¼š
  1. é«˜ä¼˜å…ˆçº§æµ‹è¯•æµé‡100%çº¿é€Ÿï¼šå»¶è¿Ÿã€æŠ–åŠ¨å’ŒåŸºå‡†ä¸€è‡´ï¼Œä¸¢åŒ…ç‡ 50% å·¦å³
  2. é«˜ä¼˜å…ˆçº§æµ‹è¯•æµé‡50%çº¿é€Ÿï¼šå»¶è¿Ÿã€æŠ–åŠ¨å’ŒåŸºå‡†ä¸€è‡´ï¼Œ0ä¸¢åŒ…ç‡

### 4. é—¨æ§ç²¾åº¦

- ç›®çš„ï¼šæµ‹è¯•é—¨æ§æ—¶éš™é•¿åº¦çš„è®¾ç½®ç²¾åº¦
- æ–¹æ¡ˆï¼š(n=1,2,4,8,...)
  1. æ¯ä¸ªè°ƒåº¦å‘¨æœŸé¢„ç•™é•¿åº¦ä¸º 1 çš„æ—¶éš™ç»™é«˜ä¼˜å…ˆçº§æµé‡
  2. æ¯ä¸ªå‘¨æœŸå‘é€ n ä¸ªæ•°æ®åŒ…é•¿åº¦ä¸º1/n*1500Byteçš„é«˜ä¼˜å…ˆçº§ï¼ˆVLAN priority = 1ï¼‰æµ‹è¯•æµé‡ï¼Œè®°å½•æ˜¯å¦æ¯ä¸ªå‘¨æœŸé€šè¿‡ n ä¸ªåŒ…
     1. n=1, 
- é¢„æœŸï¼š
  1. n=1,2,4,8 æƒ…å†µä¸‹éƒ½èƒ½æ¯ä¸ªå‘¨æœŸé€šè¿‡ä¸”ä»…é€šè¿‡ n ä¸ªåŒ…

> å¦‚æœæ‚¨æŒ‰ç…§ä¸‹æ–‡çš„é…ç½®ä½¿ç”¨æˆ‘ä»¬å¼€æºçš„ZIGGOäº¤æ¢æœºå’ŒTSNPerfï¼Œåˆ™æ‚¨å¯ä»¥åœ¨ä¸Šé¢å››ä¸ªæµ‹è¯•ä¸­å¾—åˆ°å’Œé¢„æœŸç›¸ç±»ä¼¼çš„æ•ˆæœã€‚å¦‚æœå‡ºç°äº†ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨githubä¸Šæå‡ºissueã€‚

## è®¾å¤‡å‚æ•°è®¾ç½®ä¸éƒ¨ç½²

Switchè½¯ç¡¬ä»¶ä»£ç åœ¨ä»“åº“ [ZIGGO-Caas-Switch](https://github.com/Horacehxw/Ziggo-CaaS-Switch) ä¸­ï¼Œä½¿ç”¨ä¸»åˆ†æ”¯å³å¯ã€‚

TSNPerfçš„è½¯ç¡¬ä»¶ä»£ç åœ¨æœ¬ä»“åº“ã€‚

> æ³¨æ„ï¼šå¸¦å®½èƒ½åŠ›æµ‹è¯•ä¸­çš„TSNPerféœ€è¦ä½¿ç”¨offline_analyzeåˆ†æ”¯ï¼Œé—¨æ§ç²¾åº¦æµ‹è¯•ä¸­çš„TSNPerféœ€è¦ä½¿ç”¨packet_resizeåˆ†æ”¯ã€ç”¨äºè‡ªå®šä¹‰æµ‹è¯•åŒ…å¤§å°ã€‘ã€‚æµ‹è¯•ä¸­è¯·å‹¿å¿˜è®°åˆ‡æ¢åˆ†æ”¯ã€‚

æ‰€æœ‰è®¾å¤‡çš„IPã€MACå’ŒIDå¦‚ä¸‹æ‰€ç¤ºï¼Œä¸æœ¬æ–‡æ¡£åé¢æä¾›çš„JSONé…ç½®æ–‡ä»¶å¯¹åº”ï¼š

![topo config](./topo_config.png)

å¯¹åº”çš„configæ–‡ä»¶å¯è§`config.json`

## TestBedè¿è¡Œæµç¨‹

### å‡†å¤‡å·¥ä½œ

#### æ§åˆ¶è„šæœ¬å‡†å¤‡

å¯ä»¥å‚è€ƒ [CNC-User-Manual](/device/cnc_manual/)

#### èƒŒæ™¯æµé‡å‘é€

å¯ä»¥ç›´æ¥åœ¨Linux PCä¸­è¿è¡Œ`send.py`è„šæœ¬ã€‚ï¼ˆéœ€è¦å®‰è£…scapy,tcpreplayï¼‰

### åŸºå‡†æµ‹è¯•

Switchã€TSNPerf çš„è½¯ç¡¬ä»¶éƒ½ä½¿ç”¨ä¸»åˆ†æ”¯ã€‚

æµ‹è¯•æ­¥éª¤ï¼š

1. ä¿®æ”¹batch.mjsä¿®æ”¹æ­£ç¡®çš„é…ç½®æ–‡ä»¶å
2. ./batch.mjs pullï¼ˆæ³¨æ„åˆ†æ”¯æ­£ç¡®ï¼‰
3. ./batch.mjs distribute
   Deviceæ¯æ¬¡å‘é€4ä¸ªæ•°æ®åŒ…ï¼Œæ¯ä¸ªSwitchéƒ½é¢„ç•™äº†3ä¸ªæ—¶éš™ï¼Œå°†ä»¥ä¸‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ä¸‹å‘å³å¯ï¼š
   `base/d3s2-baseline-3t-config.json`ï¼Œ
   `base/d3s2-baseline-3t-schedule-base.json`
4. ./batch.mjs launch ï¼ˆåŒ…æ‹¬äº†æ—¶é—´åŒæ­¥å’Œæ•°æ®åŒ…å‘é€ï¼‰
5. ./batch.mjs collect

### é—¨æ§èƒ½åŠ›

Switchã€TSNPerf çš„è½¯ç¡¬ä»¶éƒ½ä½¿ç”¨ä¸»åˆ†æ”¯ã€‚

1. è®©èƒŒæ™¯æµé‡Deviceå‘åŒ…ï¼ˆåŸºå‡†æµ‹è¯•ä¸éœ€è¦å‘é€èƒŒæ™¯æµé‡ï¼‰
2. ä¿®æ”¹batch.mjsä¿®æ”¹æ­£ç¡®çš„é…ç½®æ–‡ä»¶å
3. ./batch.mjs pullï¼ˆæ³¨æ„åˆ†æ”¯æ­£ç¡®ï¼‰
4. ./batch.mjs distribute
   Device1æ¯æ¬¡å‘é€4ä¸ªæ•°æ®åŒ…ï¼Œæ¯ä¸ªSwitchéƒ½é¢„ç•™äº†3ä¸ªæ—¶éš™ï¼Œå°†ä»¥ä¸‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ä¸‹å‘å³å¯ï¼š
   `gate/d3s2-baseline-3t-config.json`ï¼Œ
   `gate/d3s2-baseline-3t-schedule-gate.json`
5. ./batch.mjs launch
6. ./batch.mjs collect
7. å°†ä¸Šè¿°çš„schedule.jsonä¸­çš„Deviceå‘åŒ…ä¸ªæ•°ä»4æ”¹ä¸º8ï¼Œå†ä»ä¸Šè¿°æ­¥éª¤4é‡æ–°æµ‹è¯•ï¼Œä¿®æ”¹åçš„schedule.jsonå¦‚ä¸‹æ‰€ç¤º

```json
{
    "type": "link",
    "from": 3,
    "to": 0,
    "from_port": 0,
    "id": 7,
    "schedule": [
        {
            "period": 2048,
            "start": 0,
            "end": 8,
            "job_id": 1,
            "flow_id": 1
        }
    ]
},
```

### å¸¦å®½ä¿è¯

Switchä»£ç ä½¿ç”¨ä¸»åˆ†æ”¯ï¼ŒTSNPerfä»£ç ä½¿ç”¨offline_analyzeåˆ†æ”¯ã€‚

æµ‹è¯•æ­¥éª¤ï¼š

1. è®©èƒŒæ™¯æµé‡Deviceå‘åŒ…ï¼ˆåŸºå‡†æµ‹è¯•ä¸éœ€è¦å‘é€èƒŒæ™¯æµé‡ï¼‰

2. ä¿®æ”¹batch.mjsä¿®æ”¹æ­£ç¡®çš„é…ç½®æ–‡ä»¶å

3. ./batch.mjs pullï¼ˆæ³¨æ„åˆ†æ”¯æ­£ç¡®ï¼‰

4. ./batch.mjs distribute
   Device1æ¯æ¬¡å‘é€1376ä¸ªæ•°æ®åŒ…ï¼Œæ¯ä¸ªSwitchéƒ½é¢„ç•™äº†1024ä¸ªæ—¶éš™ï¼Œå°†ä»¥ä¸‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ä¸‹å‘å³å¯ï¼š
   `bandwidth/d3s2-baseline-50%t-config.json`ï¼Œ
   `bandwidth/d3s2-baseline-50%t-schedule.json`

5. ./batch.mjs launch

6. ä½¿ç”¨ç¦»çº¿åˆ†æ

7. å°†ä¸Šè¿°çš„schedule.jsonä¸­çš„Deviceå‘åŒ…ä¸ªæ•°ä»1376æ”¹ä¸º2752ï¼Œå†ä»ä¸Šè¿°æ­¥éª¤4é‡æ–°æµ‹è¯•ï¼Œä¿®æ”¹åçš„schedule.jsonå¦‚ä¸‹æ‰€ç¤º
   
   ```json
   {
    "type": "link",
    "from": 3,
    "to": 0,
    "from_port": 0,
    "id": 7,
    "schedule": [
        {
            "period": 2048,
            "start": 0,
            "end": 2752,
            "job_id": 1,
            "flow_id": 1
        }
    ]
   },
   ```

### é—¨æ§ç²¾åº¦

Switchä»£ç ä½¿ç”¨ä¸»åˆ†æ”¯ï¼ŒTSNPerfä»£ç ä½¿ç”¨packet_resizeåˆ†æ”¯ã€‚

1. ä¿®æ”¹batch.mjsä¿®æ”¹æ­£ç¡®çš„é…ç½®æ–‡ä»¶å

2. ./batch.mjs pullï¼ˆæ³¨æ„åˆ†æ”¯æ­£ç¡®ï¼‰

3. ./batch.mjs distribute
   Device1æ¯æ¬¡å‘é€1ä¸ª1500Bçš„æ•°æ®åŒ…ï¼Œæ¯ä¸ªSwitchéƒ½é¢„ç•™äº†1ä¸ªæ—¶éš™ï¼Œå°†ä»¥ä¸‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ä¸‹å‘å³å¯ï¼š
   `accuracy/d3s2-baseline-1t-config.json`ï¼Œ
   `accuracy/d3s2-baseline-1t-schedule.json`

4. ./batch.mjs launch

5. ./batch.mjs collect

6. å°†ä¸Šè¿°çš„schedule.jsonä¸­çš„Deviceå‘åŒ…ä¸ªæ•°ä»1åˆ†åˆ«æ”¹ä¸º2,4,8ï¼ŒåŒ…é•¿åº¦åˆ†åˆ«æ”¹ä¸º750, 375å’Œ187ï¼Œå†ä»ä¸Šè¿°æ­¥éª¤4é‡æ–°æµ‹è¯•ï¼Œå‘åŒ…ä¸ªæ•°ä¿®æ”¹ä¸º2åçš„schedule.jsonå¦‚ä¸‹æ‰€ç¤º
   
   ```json
   {
    "type": "link",
    "from": 3,
    "to": 0,
    "from_port": 0,
    "id": 7,
    "schedule": [
        {
            "period": 2048,
            "start": 0,
            "end": 2, 
            "pkt_size": 750, // 1500/2 = 750 
            "job_id": 1,
            "flow_id": 1
        }
    ]
   },
   ```